#include <lpc214x.h>
#include "vec_int.h"
#include <math.h>

#define VPB_CLK_FREQ 15e6

int input_wave[] = {
	1650,1779,1908,2035,2160,2281,2399,2512,2620,2722,2817,2905,2985,
	3057,3120,3174,3219,3254,3280,3295,3300,3295,3280,3254,3219,
	3174,3120,3057,2985,2905,2817,2722,2620,2512,2399,2281,2160,
	2035,1908,1779,1650,1521,1392,1265,1140,1019,901,788,680,578,
	483,395,315,243,180,126,81,46,20,5,0,5,20,46,81,126,180,243,
	315,395,483,578,680,788,901,1019,1140,1265,1392,1521,1650,1779,
	1908,2035,2160,2281,2399,2512,2620,2722,2817,2905,2985,3057,3120,
	3174,3219,3254,3280,3295,3300,3295,3280,3254,3219,3174,3120,3057,
	2985,2905,2817,2722,2620,2512,2399,2281,2160,2035,1908,1779,1650,
	1521,1392,1265,1140,1019,901,788,680,578,483,395,315,243,180,126,
	81,46,20,5,0,5,20,46,81,126,180,243,315,395,483,578,680,788,901,1019,
	1140,1265,1392,1521,1650,1779,1908,2035,2160,2281,2399,2512,2620,2722,
	2817,2905,2985,3057,3120,3174,3219,3254,3280,3295,3300,3295,3280,
	3254,3219,3174,3120,3057,2985,2905,2817,2722,2620,2512,2399,2281,
	2160,2035,1908,1779,1650,1521,1392,1265,1140,1019,901,788,680,578,
	483,395,315,243,180,126,81,46,20,5,0,5,20,46,81,126,180,243,315,
	395,483,578,680,788,901,1019,1140,1265,1392,1521,1650,1779,1908,
	2035,2160,2281,2399,2512,2620,2722,2817,2905,2985,3057,3120,3174,
	3219,3254,3280,3295,3300,3295,3280,3254,3219,3174,3120,3057,2985,
	2905,2817,2722,2620,2512,2399,2281,2160,2035,1908,1779,1650,1521,
	1392,1265,1140,1019,901,788,680,578,483,395,315,243,180,126,81,46,
	20,5,0,5,20,46,81,126,180,243,315,395,483,578,680,788,901,1019,1140,
	1265,1392,1521,1650,1779,1908,2035,2160,2281,2399,2512,2620,2722,
	2817,2905,2985,3057,3120,3174,3219,3254,3280,3295,3300,3295,3280,
	3254,3219,3174,3120,3057,2985,2905,2817,2722,2620,2512,2399,2281,
	2160,2035,1908,1779,1650,1521,1392,1265,1140,1019,901,788,680,578,
	483,395,315,243,180,126,81,46,20,5,0,5,20,46,81,126,180,243,315,395,
	483,578,680,788,901,1019,1140,1265,1392,1521,1650,1779,1908,2035,2160,
	2281,2399,2512,2620,2722,2817,2905,2985,3057,3120,3174,3219,3254,
	3280,3295,3300,3295,3280,3254,3219,3174,3120,3057,2985,2905,2817,
	2722,2620,2512,2399,2281,2160,2035,1908,1779,1650,1521,1392,1265,1140,
	1019,901,788,680,578,483,395,315,243,180,126,81,46,20,5,0,5,20,46,81,
	126,180,243,315,395,483,578,680,788,901,1019,1140,1265,1392,1521,1650,
	1779,1908,2035,2160,2281,2399,2512,2620,2722,2817,2905,2985,3057,3120,
	3174,3219,3254,3280,3295,3300,3295,3280,3254,3219,3174,3120,3057,2985,
	2905,2817,2722,979,1265,1564,1865,2160,2437,2688,2905,3079,3205,3280,
	3299,3264,3174,3034,2847,2620,2360,2077,1779,1478,1181,901,646,424,243,
	110,28,0,28,110,243,424,646,901,1181,1478,1779,2077,2360,2620,2847,3034,
	3174,3264,3299,3280,3205,3079,2905,2688,2437,2160,1865,1564,1265,979,
	715,483,290,143,46,2,14,81,200,368,578,825,1099,1392,1693,1993,2281,
	2549,2786,2985,3139,3244,3295,3291,3232,3120,2959,2754,2512,2241,
	1951,1650,1349,1059,788,546,341,180,68,9,5,56,161,315,514,751,1019,
	1307,1607,1908,2201,2475,2722,2932,3100,3219,3286,3298,3254,3157,3010,
	2817,2585,2321,2035,1736,1435,1140,863,612,395,221,95,20,1,36,126,266,
	453,680,940,1223,1521,1822,2119,2399,2654,2876,3057,3190,3272,3300,3272,
	3190,3057,2876,2654,2399,2119,1822,1521,1223,940,680,453,266,126,36,1,20,
	95,221,395,612,863,1140,1435,1736,2035,2321,2585,2817,3010,3157,3254,
	3298,3286,3219,3100,2932,2722,2475,2201,1908,1607,1307,1019,751,514,
	315,161,56,5,9,68,180,341,546,788,1059,1349,1650,1951,2241,2512,2754,
	2959,3120,3232,3291,3295,3244,3139,2985,2786,2549,2281,1993,1693,1392,
	1099,825,578,368,200,81,14,2,46,143,290,483,715,979,1265,1564,1865,2160,
	2437,2688,2905,3079,3205,3280,3299,3264,3174,3034,2847,2620,2360,2077,
	1779,1478,1181,901,646,424,243,110,28,0,28,110,243,424,646,901,1181,1478,
	1779,2077,2360,2620,2847,3034,3174,3264,3299,3280,3205,3079,2905,2688,
	2437,2160,1865,1564,1265,979,715,483,290,143,46,2,14,81,200,368,578,825,
	1099,1392,1693,1993,2281,2549,2786,2985,3139,3244,3295,3291,3232,3120,
	2959,2754,2512,2241,1951,1650,1349,1059,788,546,341,180,68,9,5,56,161,
	315,514,751,1019,1307,1607,1908,2201,2475,2722,2932,3100,3219,3286,3298,
	3254,3157,3010,2817,2585,2321,2035,1736,1435,1140,863,612,395,221,95,20,
	1,36,126,266,453,680,940,1223,1521,1822,2119,2399,2654,2876,3057,3190,
	3272,3300,3272,3190,3057,2876,2654,2399,2119,1822,1521,1223,940,680,453,
	266,126,36,1,20,95,221,395,612,863,1140,1435,1736,2035,2321,2585,2817,
	3010,3157,3254,3298,3286,3219,3100,2932,2722,2475,2201,1908,1607,1307,
	1019,751,514,315,161,56,5,9,68,180,341,546,788,1059,1349,1650,1951,2241,
	2512,2754,2959,3120,3232,3291,3295,3244,3139,2985,2786,2549,2281,1993,
	1693,1392,1099,825,578,368,200,81,14,2,46,143,290,483,715,979,1265,1564,
	1865,2160,2437,2688,2905,3079,3205,3280,3299,3264,3174,3034,2847,2620,
	2360,2077,1779,1478,1181,901,646,424,243,110,28,0,28,110,243
}; 

int main(){
	// Fosc = 12MHz
	// CCLK = 60MHz
	// PCLK = 15MHz 
	// Sampling time period = ms
	// ADC clock frequency ~ 4.5MHz
	// Algorithm Computation time ~ 3ms
	// Baud rate = bps
	
	
	
	PLL0CFG = 0x24; // CCLK = 60MHz, CCO = 240MHz
	PLL0CON = 0x1;    // turn on PLL 
	PLL0FEED = 0xAA;  // feed sequence for changes to take effect
	PLL0FEED = 0x55;
	
	while(!(PLL0STAT & (1 << 10)));
	
	PLL0CON |= 1 << 1; // connect PLL to processor
	PLL0FEED = 0xAA;   // feed sequence for changes to take effect
	PLL0FEED = 0x55;
	
	VPBDIV = 0; // VPB = CCLK/4 = 15MHz;
	/*
	T0TCR = 1 << 2; // reset TC and PC
	T0CTCR = 0; 	// timer mode
	T0MCR = 0x3; 	// interrupt and reset when it matches MR0
	T0PR = 0;
	//T0MR0 = 15e6 - 1; // 5 sec delay
	
	PINSEL1 = 1 << 24; // AD0.1
	int CLKDIV = VPB_CLK_FREQ/(4.5*1e6) - 1; // ADC clock frequency ~ 4.5MHz
	AD0CR = (1 << 2) | (CLKDIV << 8) | (1 << 21); // ADC operational,  10-bit accuracy
	AD0INTEN = 1 << 2; // generate interrupt after conversion, ADC channel 1
	
	VICIntEnable = (1 << 18) | (1 << 4); // ADC0, TIMER0
	VICIntSelect = (0 << 18) | (0 << 4); // IRQ
	
	VICVectCntl0 = (1 << 5) | 4;  // TIMER0
	VICVectCntl1 = (1 << 5) | 18; // ADC0
	
	VICVectAddr0 = (unsigned) TIMER_ISR;
	VICVectAddr1 = (unsigned) ADC_ISR;
	
	T0TCR = 0x1;
	
	while(1);

*/	PINSEL1 = (1 << 28) | (2 << 18);
	int i = 0;
	IO0DIR = 1;
	IO0SET = 1;
	while(1){
		int dac_output = ceil(1023*((float)input_wave[i++]/1000)/3.3);
		DACR = dac_output << 6;
		for(int j=0; j<6e2; j++);
		if(i == 1024){ i = 0; IO0CLR = 1; }
	}
}
